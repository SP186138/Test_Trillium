DATABASE MDM;

REPLACE VIEW MDM.CNSMR_VALID
AS
LOCKING ROW FOR ACCESS

SELECT
  PRSNA_STG_1.MKTNG_PGM_NBR
 ,PRSNA_STG_1.REGIS_CNSMR_ID_VAL
 ,CASE WHEN (
       (
       (PRSNA_EMAIL_ADDR_STG_1.CNTCT_OPTN_IND='I' AND B.CNTCT_POINT_TYPE_CODE='EMAIL')
       OR
       (PRSNA_PHONE_STG_1.CNTCT_OPTN_IND='I' AND B.CNTCT_POINT_TYPE_CODE='PHONE')
       OR
       (PRSNA_POSTL_ADDR_STG_1.CNTCT_OPTN_IND='I' AND B.CNTCT_POINT_TYPE_CODE='POSTAL')
       )
       AND
       (
       (PRSNA_POSTL_ADDR_STG_2.MKTNG_PGM_NBR IS NOT NULL)
       AND
       (PRSNA_PHONE_STG_2.MKTNG_PGM_NBR IS NOT NULL)
       AND
       (PRSNA_EMAIL_ADDR_STG_2.MKTNG_PGM_NBR IS NOT NULL)
       )
       )
       THEN 'Y'
       ELSE 'N'
   END AS VALID_STATUS

  FROM ICRM_STAGE.PRSNA_STG PRSNA_STG_1

  LEFT OUTER JOIN ICRM_STAGE.PRSNA_POSTL_ADDR_STG PRSNA_POSTL_ADDR_STG_1
    ON PRSNA_STG_1.MKTNG_PGM_NBR = PRSNA_POSTL_ADDR_STG_1.MKTNG_PGM_NBR
   AND PRSNA_STG_1.REGIS_CNSMR_ID_VAL = PRSNA_POSTL_ADDR_STG_1.REGIS_CNSMR_ID_VAL

  LEFT OUTER JOIN ICRM_STAGE.PRSNA_PHONE_STG PRSNA_PHONE_STG_1
    ON PRSNA_STG_1.MKTNG_PGM_NBR = PRSNA_PHONE_STG_1.MKTNG_PGM_NBR
   AND PRSNA_STG_1.REGIS_CNSMR_ID_VAL = PRSNA_PHONE_STG_1.REGIS_CNSMR_ID_VAL
 
  LEFT OUTER JOIN ICRM_STAGE.PRSNA_EMAIL_ADDR_STG PRSNA_EMAIL_ADDR_STG_1
    ON PRSNA_STG_1.MKTNG_PGM_NBR = PRSNA_EMAIL_ADDR_STG_1.MKTNG_PGM_NBR
   AND PRSNA_STG_1.REGIS_CNSMR_ID_VAL = PRSNA_EMAIL_ADDR_STG_1.REGIS_CNSMR_ID_VAL

 INNER JOIN CNTCT_OPTN_TYPE_STG B
    ON PRSNA_STG_1.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
   AND PRSNA_STG_1.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL

  LEFT OUTER JOIN (SELECT 
                           PRSNA_POSTL_ADDR_STG_1.MKTNG_PGM_NBR
                          ,PRSNA_POSTL_ADDR_STG_1.REGIS_CNSMR_ID_VAL
                     FROM ICRM_STAGE.PRSNA_POSTL_ADDR_STG PRSNA_POSTL_ADDR_STG_1
                    GROUP BY 1,2
                   HAVING COUNT(*) <= 1
                  ) PRSNA_POSTL_ADDR_STG_2
    ON PRSNA_STG_1.MKTNG_PGM_NBR = PRSNA_POSTL_ADDR_STG_2.MKTNG_PGM_NBR
   AND PRSNA_STG_1.REGIS_CNSMR_ID_VAL = PRSNA_POSTL_ADDR_STG_2.REGIS_CNSMR_ID_VAL

  LEFT OUTER JOIN (SELECT 
                           PRSNA_PHONE_STG_1.MKTNG_PGM_NBR
                          ,PRSNA_PHONE_STG_1.REGIS_CNSMR_ID_VAL
                     FROM ICRM_STAGE.PRSNA_PHONE_STG PRSNA_PHONE_STG_1
                    GROUP BY 1,2
                   HAVING COUNT(*) <= 2
                  ) PRSNA_PHONE_STG_2
    ON PRSNA_STG_1.MKTNG_PGM_NBR = PRSNA_PHONE_STG_2.MKTNG_PGM_NBR
   AND PRSNA_STG_1.REGIS_CNSMR_ID_VAL = PRSNA_PHONE_STG_2.REGIS_CNSMR_ID_VAL
 
  LEFT OUTER JOIN (SELECT 
                           PRSNA_EMAIL_ADDR_STG_1.MKTNG_PGM_NBR
                          ,PRSNA_EMAIL_ADDR_STG_1.REGIS_CNSMR_ID_VAL
                     FROM ICRM_STAGE.PRSNA_EMAIL_ADDR_STG PRSNA_EMAIL_ADDR_STG_1
                    GROUP BY 1,2
                   HAVING COUNT(*) <= 2
  ) PRSNA_EMAIL_ADDR_STG_2
    ON PRSNA_STG_1.MKTNG_PGM_NBR = PRSNA_EMAIL_ADDR_STG_2.MKTNG_PGM_NBR
   AND PRSNA_STG_1.REGIS_CNSMR_ID_VAL = PRSNA_EMAIL_ADDR_STG_2.REGIS_CNSMR_ID_VAL

;
